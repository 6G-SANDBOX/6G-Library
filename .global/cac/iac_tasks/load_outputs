---
- name: Retrieve current terraform outputs
  ansible.builtin.shell:
  args:
    chdir: "{{ workspace }}/{{ component_type }}/code/{{ site_hypervisor }}/iac/"
    cmd: "set -o pipefail && terraform output --json | jq 'with_entries(.value |= .value)'"
    executable: /bin/bash
  register: current_outputs
  changed_when: false


- name: Load them as host facts
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}"
  with_dict: "{{ current_outputs | from_json}}"
