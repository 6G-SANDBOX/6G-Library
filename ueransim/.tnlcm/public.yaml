######################################################
##
## Component public variables
##
## Diverse information read by the TNLCM
## to adapt its behaviour depending on the component.
##
######################################################


####################################
## Component metadata
####################################
metadata:
  maintainers:
    - Jesus Macias Portela <jesus.maciasportela@telefonica.com>
    - Ana Isabel Lara García <anaisabel.laragarcia@telefonica.com>
    - Álvaro Curto Merino <alvaro.curtomerino@telefonica.com>
  short_description: Deploys a VM with UERANSIM services 
  long_description: |
    The UERANSIM component can be used as a 5G User Equipment (UE), a gNB, as both or as None, according
    to input variables `one_ueransim_run_gnb` and `one_ueransim_run_ue` or a combination of them.
    
    Depending on the chosen behaviour (with input variables `one_ueransim_run_gnb` and 
    `one_ueransim_run_ue` respectivelly), the following dependencies are aplied:
    - If `one_ueransim_run_gnb == true`, a previously deployed `open5gs` component can be
    referenced in the `one_ueransim_gnb_linked_open5gs` input variable to autocomplete gNB-related
    variables.
    - If `one_ueransim_run_gnb == false and one_ueransim_run_ue == true`, a previously deploye
     `ueransim` component with `one_ueransim_run_gnb == true` can be referenced in the
     `one_ueransim_ue_linked_gnb` input variable to autocomplete UE-related variables.
    - If `one_ueransim_run_gnb == true` and `one_ueransim_run_ue == true`, the UE-related variables
    will be automatically autocompleted by default with the gnB-related variables.
  hypervisors: ["one"]
  appliances: ["https://marketplace.mobilesandbox.cloud:9443/appliance/service_UERANSIM"]


####################################
## Site-specific variables
####################################
site_variables:
  template_id: ID of the UERANSIM VM template to use in your OpenNebula environment
  image_id: ID of the UERANSIM VM image to use in your OpenNebula environment


####################################
## Input variables
####################################
input:
  one_ueransim_networks:
    description: Ordered list of Virtual Network names the VM will be part of. The first Virtual Network is used by Jenkins to reach and configure the VM, so most cases will be fine using always the tn_vxlan
    type: "list[tn_vxlan or vnet]"
    default_value: ["tn_vxlan"]
    required_when: false

  # gNB-related variables
  one_ueransim_run_gnb: 
    description: |
      Start and enable systemd service `ueransim-gnb.service` at boot.
    type: bool
    default_value: false
    required_when: false
  one_ueransim_gnb_linked_open5gs:
    description: |
      Name of a previously deployed 'open5gs' component (either `open5gs_k8s` or `open5gs_vm`).
      When variable `one_ueransim_run_gnb` is true, it defines the 5G SA core the gNB will try to connect to, and will autocomplete other variables acordingly.
    type: "open5gs_k8s or open5gs_vm or upf_p4_sw or open5gcore_vm"
    default_value: null
    required_when: false
  one_ueransim_gnb_amf_ip:
    description: |
      In gNB simulation, IPv4 address of the Access and Mobility Management Function (AMF) in the 5G core network.
      AMF port is currently hardcoded to always be 38412.
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: str
    default_value: "10.21.12.200"
    required_when: false
  # TODO: delete it as the tn_bastion can directly handle the routing.
  one_ueransim_gnb_amf_proxy:
    description: |
      In gNB simulation, IPv4 address where traffic to the `one_ueransim_gnb_amf_ip` should be routed to.
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: str
    default_value: null
    required_when: false
  one_ueransim_gnb_tac:
    description: In gNB simulation, Tracking Area Code (TAC) of the PLMN. Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: int
    default_value: 200
    required_when: false
  one_ueransim_gnb_mcc:
    description: |
      In gNB simulation, Mobile Country Code (MCC) used in the Public Land Mobile Network (PLMN). 3 digits inside quotes.
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: str
    default_value: "001"
    required_when: false
  one_ueransim_gnb_mnc:
    description: |
      In gNB simulation, Mobile Network Code (MNC) used in the Public Land Mobile Network (PLMN). 2 or 3 digits inside quotes.
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: str
    default_value: "01"
    required_when: false
  one_ueransim_gnb_slices_sst:
    description: |
      In gNB simulation, Slice/Service Type (SST) of the Single-Network Slice Selection Assistant Information (S-NSSAI).
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: int
    default_value: 1
    required_when: false
  one_ueransim_gnb_slices_sd:
    description: |
      In gNB simulation, Slice Differentiator (SD) of the Single-Network Slice Selection Assistant Information (S-NSSAI). Minimum length of 6.
      Autocompleted by default with values from `one_ueransim_gnb_linked_open5gs` if defined.
    type: str
    default_value: "000001"
    required_when: false

  # UE-related variables
  one_ueransim_run_ue: 
    description: |
      Start and enable systemd service `ueransim-ue.service` at boot.
    type: bool
    default_value: false
    required_when: false
  one_ueransim_ue_linked_gnb:
    description: |
      Name of a previously deployed `ueransim` component serving as gNB (with `one_ueransim_run_gnb == true`)
      When variable `one_ueransim_run_ue` is true, it defines the gNB/RAN the User Equipment will try to connect to, and will autocomplete other variables acordingly.
    type: "ueransim"
    default_value: null
    required_when: false
  one_ueransim_ue_gnbsearchlist:
    description: |
      In UE simulation, comma-separated list of IPv4 addresses where the UE will search for gNBs for Radio Link Simulation.
      The special value 'localhost' will be replaced with the IP of the first asigned vnet to the VM (usually tn_vxlan).
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: "str"
    default_value: "localhost"
    required_when: false
  one_ueransim_ue_mcc:
    description: |
      In UE simulation, Mobile Country Code (MCC) used in the Public Land Mobile Network (PLMN). 3 digits inside quotes.
      Values `one_ueransim_ue_mcc` + `one_ueransim_ue_mnc` + `one_ueransim_ue_msin` must add to exactly 15 digits to form a valid IMSI.
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "001"
    required_when: false
  one_ueransim_ue_mnc:
    description: |
      In UE simulation, Mobile Network Code (MNC) used in the Public Land Mobile Network (PLMN). 2 or 3 digits inside quotes.
      Values `one_ueransim_ue_mcc` + `one_ueransim_ue_mnc` + `one_ueransim_ue_msin` must add to exactly 15 digits to form a valid IMSI.
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "01"
    required_when: false
  one_ueransim_ue_msin:
    description: |
      In UE simulation, Mobile Subscriber Identification Number (MSIN) used in the Public Land Mobile Network (PLMN). 9 or 10 digits inside quotes.
      Values `one_ueransim_ue_mcc` + `one_ueransim_ue_mnc` + `one_ueransim_ue_msin` must add to exactly 15 digits to form a valid IMSI.
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "0000000001"
    required_when: false
  one_ueransim_ue_key:
    description: In UE simulation, Permanent subscription key of the UE. Autocompleted by default with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "465B5CE8B199B49FAA5F0A2EE238A6BC"
    required_when: false
  one_ueransim_ue_opc:
    description: In UE simulation, Operator code (OP or OPC) of the UE. Autocompleted by default with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "E8ED289DEBA952E4283B54E88E6183CA"
    required_when: false
  one_ueransim_ue_session_apn:
    description: In UE simulation, Access Point Name (APN) of the initial PDU session to be established. Autocompleted by default with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "internet"
    required_when: false
  one_ueransim_ue_session_sst:
    description: |
      In UE simulation, Slice/Service Type (SST) of the initial PDU session to be established.
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: int
    default_value: 1
    required_when: false
  one_ueransim_ue_session_sd:
    description: |
      In UE simulation, Slice Differentiator (SD) of the initial PDU session to be established. Minimum length of 6.
      Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
      with values from `one_ueransim_ue_linked_gnb` if defined.
    type: str
    default_value: "000001"
    required_when: false
  # one_ueransim_ue_configured_nssai_sst:
  #   description: |
  #     In UE simulation, Slice/Service Type (SST) of the configured NSSAI by HPLMN.
  #     Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
  #     with values from `one_ueransim_ue_linked_gnb` if defined.
  #   type: int
  #   default_value: 1
  #   required_when: false
  # one_ueransim_ue_configured_nssai_sd:
  #   description: |
  #     In UE simulation, Slice Differentiator (SD) of the configured NSSAI by HPLMN. Minimum length of 6.
  #     Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
  #     with values from `one_ueransim_ue_linked_gnb` if defined.
  #   type: str
  #   default_value: "000001"
  #   required_when: false
  # one_ueransim_ue_default_nssai_sst:
  #   description: |
  #     In UE simulation, Slice/Service Type (SST) of the default NSSAI.
  #     Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
  #     with values from `one_ueransim_ue_linked_gnb` if defined.
  #   type: int
  #   default_value: 1
  #   required_when: false
  # one_ueransim_ue_default_nssai_sd:
  #   description: |
  #     In UE simulation, Slice Differentiator (SD) of the default NSSAI. Minimum length of 6.
  #     Autocompleted by default from gNB-related variables if `one_ueransim_run_gnb == true`, or else 
  #     with values from `one_ueransim_ue_linked_gnb` if defined.
  #   type: str
  #   default_value: "000001"
  #   required_when: false


####################################
## Generated terraform outputs
####################################
terraform_outputs:
  __entity_name__id: "VM ID in OpenNebula. Generated from Terraform Manifest"
  __entity_name__ips: "Dictionary of VM IP addresses: {<VNet ID in OpenNebula>: <IP address>}. Generated from Terraform Manifest"
  __entity_name__run_gnb: input.one_ueransim_run_gnb
  __entity_name__gnb_metadata:
    linked_open5gs: input.one_ueransim_gnb_linked_open5gs
    amf_ip: input.one_ueransim_gnb_amf_ip
    amf_proxy: input.one_ueransim_gnb_amf_proxy
    tac: input.one_ueransim_gnb_tac
    mcc: input.one_ueransim_gnb_mcc
    mnc: input.one_ueransim_gnb_mnc
    msin: "Inferred from 'linked_open5gs', or generated by padding mcc and mnc in order to form a valid IMSI"
    key: "Inferred from 'linked_open5gs', or set to None"
    opc: "Inferred from 'linked_open5gs', or set to None"
    apn: "Inferred from 'linked_open5gs', or set to None"
    sst: input.one_ueransim_gnb_slices_sst
    sd: input.one_ueransim_gnb_slices_sd
  __entity_name__run_ue: input.one_ueransim_run_ue
  __entity_name__ue_metadata:
    linked_gnb: input.one_ueransim_ue_linked_gnb
    gnbsearchlist: input.one_ueransim_ue_gnbsearchlist
    mcc: input.one_ueransim_ue_mcc
    mnc: input.one_ueransim_ue_mnc
    msin: input.one_ueransim_ue_msin
    key: input.one_ueransim_ue_key
    opc: input.one_ueransim_ue_opc
    apn: input.one_ueransim_ue_session_apn
    sst: input.one_ueransim_ue_session_sst
    sd:  input.one_ueransim_ue_session_sd
